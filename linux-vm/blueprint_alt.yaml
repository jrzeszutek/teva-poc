tosca_definitions_version: cloudify_dsl_1_3


imports:
  - https://cloudify.co/spec/cloudify/5.1.2/types.yaml
  - plugin:cloudify-terraform-plugin


inputs:
  tf_installation_source:
    type: string
    constraints:
      - valid_values:
          - https://releases.hashicorp.com/terraform/0.14.3/terraform_0.14.3_linux_amd64.zip
          - https://releases.hashicorp.com/terraform/0.14.4/terraform_0.14.4_linux_amd64.zip
    default: https://releases.hashicorp.com/terraform/0.14.3/terraform_0.14.3_linux_amd64.zip

  az_location:
    type: string
    constraints:
      - valid_values:
        - eastasia
        - southeastasia
        - centralus
        - eastus
        - eastus2
        - westus
        - northcentralus
        - southcentralus
        - northeurope
        - westeurope
        - japanwest
        - japaneast
        - brazilsouth
        - australiaeast
        - australiasoutheast
        - southindia
        - centralindia
        - westindia
        - canadacentral
        - canadaeast
        - uksouth
        - ukwest
        - westcentralus
        - westus2
        - koreacentral
        - koreasouth
        - francecentral
        - francesouth
        - australiacentral
        - australiacentral2
        - southafricanorth
        - southafricawest
  
  vm_name:
    type: string
    required: false

  az_resource_group_name:
    type: string

  tags:
    type: dict
    required: false

  vm_info:
    type: dict

  disks:
    type: dict

  role:
    type: string

  ppg_id:
    type: string
    required: false

  ssh_public_data:
    type: string

  disk_enc:
    type: dict
    default:
      KeyVaultURL: ""
      KeyVaultResourceId: ""
      KeyEncryptionKeyURL: ""
      KekVaultResourceId: ""
      KeyEncryptionAlgorithm: ""

  subnet:
    type: dict

  bootstrap_settings:
    type: dict
  

node_templates:
  terraform:
    type: cloudify.nodes.terraform
    properties:
      resource_config:
        installation_source: { get_input: tf_installation_source }
        # installation_source: https://releases.hashicorp.com/terraform/0.14.3/terraform_0.14.3_linux_amd64.zip
  
  terraform_module:
    type: cloudify.nodes.terraform.Module
    properties:
      resource_config:
        environment_variables:
          arm_subscription_id: { get_secret: arm_subscription_id }
          arm_tenant_id: { get_secret: arm_tenant_id }
          local_admin_passwd: { get_secret: local_admin_passwd }
          storage_account_key: { get_secret: storage_account_key }
        variables:
          az_location: { get_input: az_location }
          vm_name: { get_input: vm_name }
          az_resource_group_name: { get_input: az_resource_group_name }
          tags: { get_input: tags }
          vm_info: { get_input: vm_info }
          disks: { get_input: disks }
          role: { get_input: role }
          ppg_id: { get_input: ppg_id }
          ssh_public_data: { get_input: ssh_public_data }
          disk_enc: { get_input: disk_enc }
          subnet: { get_input: subnet }
          bootstrap_settings: { get_input: bootstrap_settings }
        source:
          location: PUT TERRAFORM TEMPLATE LOCATION HERE (URL)
    relationships:
      - target: terraform
        type: cloudify.terraform.relationships.run_on_host


capabilities:
  ip:
    value: { get_attribute: [ terraform_module, resources, vm, instances, 0, attributes, ip ] }

  username:
    value: { get_attribute: [ terraform_module, resources, vm, instances, 0, attributes, username ] }
    
  private_key_content:
    value: { get_attribute: [ terraform_module, resources, vm, instances, 0, attributes, private_key_content ] }
