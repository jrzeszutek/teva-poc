tosca_definitions_version: cloudify_dsl_1_3


imports:
  - https://cloudify.co/spec/cloudify/5.1.2/types.yaml
  - plugin:cloudify-terraform-plugin

inputs:

  tf_installation_source:
    type: string
    constraints:
      - valid_values:
        - https://releases.hashicorp.com/terraform/0.14.3/terraform_0.14.3_linux_amd64.zip
        - https://releases.hashicorp.com/terraform/0.14.4/terraform_0.14.4_linux_amd64.zip
    default: https://releases.hashicorp.com/terraform/0.14.3/terraform_0.14.3_linux_amd64.zip

  az_location:
    type: string
    constraints:
      - valid_values:
        - eastasia
        - southeastasia
        - centralus
        - eastus
        - eastus2
        - westus
        - northcentralus
        - southcentralus
        - northeurope
        - westeurope
        - japanwest
        - japaneast
        - brazilsouth
        - australiaeast
        - australiasoutheast
        - southindia
        - centralindia
        - westindia
        - canadacentral
        - canadaeast
        - uksouth
        - ukwest
        - westcentralus
        - westus2
        - koreacentral
        - koreasouth
        - francecentral
        - francesouth
        - australiacentral
        - australiacentral2
        - southafricanorth
        - southafricawest
  
  vm_name:
    type: string
    default: azsapapp12s

  az_resource_group_name:
    type: string
    default: rg-cfin-auto-sbx-001

  tags:
    type: dict
    required: false

  disks:
    type: dict
    required: false

  role:
    type: string
    constraints:
      - valid_values:
        - generic
        - app
        - db
    default: app

  ppg_id:
    type: string
    required: false

  ssh_public_data:
    type: string
    default: { get_secret: ssh_public_data }

  disk_enc:
    type: dict
    default:
      KeyVaultURL: ""
      KeyVaultResourceId: ""
      KeyEncryptionKeyURL: ""
      KekVaultResourceId: ""
      KeyEncryptionAlgorithm: ""

  subnet:
    type: dict
    default:
      name: "snet-cfin-sbx-eun-001"
      resource_group_name: "rg-cfin-inf-sbx-001"
      vnet_name: "vnet-cfin-sbx-eun-001"
  

node_templates:
  terraform:
    type: cloudify.nodes.terraform
    properties:
      resource_config:
        installation_source: { get_input: tf_installation_source }

  authenticator:
    type: cloudify.nodes.Root
    interfaces:
      cloudify.interfaces.lifecycle:
        start: 
          implementation: scripts/get_auth_credentials.py
          executor: central_deployment_agent
    relationships:
      - type: cloudify.relationships.depends_on
        target: terraform
  
  terraform_module:
    type: cloudify.nodes.terraform.Module
    properties:
      resource_config:
        environment_variables: # dynamically generated provider
          ARM_SUBSCRIPTION_ID: { get_attribute: [authenticator, arm_subscription_id] }
          ARM_TENANT_ID: { get_attribute: [authenticator, arm_tenant_id] }
          ARM_USE_MSI: true
          ARM_SKIP_PROVIDER_REGISTRATION: true
        variables:
          az_location: { get_input: az_location }
          vm_name: { get_input: vm_name }
          az_resource_group_name: { get_input: az_resource_group_name }
          tags: { get_input: tags }
          vm_info:
            os_image:
              publisher: "redhat"
              offer: "rhel-sap-apps"
              sku: "82sapapps-gen2"
              version: "latest"
            storage_os_disk:
              caching: "ReadWrite"
              create_option: "FromImage"
              managed_disk_type: "StandardSSD_LRS"
            os_profile:
              admin_username: "azadmin"
              admin_password: { get_attribute: [authenticator, local_admin_passwd] }
            general:
              size: "Standard_D4ds_v4"
              zone: 3 # Must be null if not set
              role: { get_input: role }
          disks: { get_input: disks }
          role: { get_input: role }
          ppg_id: { get_input: ppg_id }
          ssh_public_data: { get_secret: ssh_public_data }
          disk_enc: { get_input: disk_enc }
          subnet: { get_input: subnet }
          bootstrap_settings: { get_secret: bootstrap_settings }
        source:
          location: ssh.dev.azure.com:v3/Teva-CCOE/Infra/terraform-azurerm-teva-vm-linux
          username: { get_secret: git_username }
          password: { get_secret: git_password }
        backend:
          name: azurerm
          options:
            resource_group_name: "rg-pah-inf-prod-001" # Add this because of https://github.com/hashicorp/terraform/issues/23515
            storage_account_name: "stgpah1a4jvdokprod001"
            container_name: "tfstate"
            key: # test it!
              concat:
              - { get_input: role }
              - /vm.terraform.tfstate
            use_msi: true
            subscription_id: { get_attribute: [authenticator, arm_subscription_id] }
            tenant_id: { get_attribute: [authenticator, arm_tenant_id] }
    relationships:
      - target: authenticator
        type: cloudify.relationships.depends_on
      - target: terraform
        type: cloudify.terraform.relationships.run_on_host


capabilities:
  ip:
    value: { get_attribute: [ terraform_module, resources, vm, instances, 0, attributes, ip ] }

  username:
    value: { get_attribute: [ terraform_module, resources, vm, instances, 0, attributes, username ] }

  private_key_content:
    value: { get_attribute: [ terraform_module, resources, vm, instances, 0, attributes, private_key_content ] }
  
